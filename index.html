<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Inventarios</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .critical { color: #e74c3c; }
        .warning { color: #f39c12; }
        .success { color: #27ae60; }
        .info { color: #3498db; }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .section h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .product-list {
            margin-bottom: 20px;
        }

        .product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: transform 0.2s ease;
        }

        .product-item:hover {
            transform: scale(1.02);
        }

        .critical-item { background: rgba(231, 76, 60, 0.1); border-left: 4px solid #e74c3c; }
        .warning-item { background: rgba(243, 156, 18, 0.1); border-left: 4px solid #f39c12; }
        .success-item { background: rgba(39, 174, 96, 0.1); border-left: 4px solid #27ae60; }

        .product-info {
            flex: 1;
        }

        .product-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .product-details {
            font-size: 0.9em;
            color: #666;
        }

        .product-stock {
            text-align: right;
            font-weight: 600;
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .inventory-table th,
        .inventory-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .inventory-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .badge-critical { background: #e74c3c; color: white; }
        .badge-warning { background: #f39c12; color: white; }
        .badge-success { background: #27ae60; color: white; }

        .action-buttons {
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <img src="https://idip.com.mx/wp-content/uploads/2024/08/logos-IDIP-sin-fondo-1-2.png" alt="Logotipo de IDIP" style="max-height: 50px; margin-bottom: 20px;">
            <h1>📦 Dashboard de Inventarios</h1>
            <p>Sistema inteligente de control de stock con sincronización automática desde Google Sheets</p>
            <div style="margin-top: 15px; padding: 10px; background: rgba(39, 174, 96, 0.1); border-radius: 8px; border-left: 4px solid #27ae60;">
                <strong>✅ Conectado a Google Sheets:</strong>
                <a href="https://docs.google.com/spreadsheets/d/14A7s3X1SYBsu1XATk2cTg9XtTE-t0gWm9CtTXv4l83M" target="_blank" style="color: #27ae60; text-decoration: none;">
                    📊 Ver/Editar Hoja de Inventario
                </a>
                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                    <span id="lastSync">Última sincronización: Cargando...</span>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number critical" id="criticalCount">2</div>
                <div>Productos Críticos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number warning" id="warningCount">2</div>
                <div>Stock Bajo</div>
            </div>
            <div class="stat-card">
                <div class="stat-number success" id="normalCount">2</div>
                <div>Stock Normal</div>
            </div>
            <div class="stat-card">
                <div class="stat-number info" id="totalValue">$0.00 MXN</div>
                <div>Valor Total</div>
            </div>
        </div>

        <div class="content-grid">
            <div class="section">
                <h2>🚨 Alertas Prioritarias</h2>
                
                <h3 style="color: #e74c3c; margin-bottom: 15px;">🔴 Críticos - Pedir HOY</h3>
                <div class="product-list" id="criticalProducts">
                    </div>

                <h3 style="color: #f39c12; margin-bottom: 15px;">🟡 Bajos - Planificar Esta Semana</h3>
                <div class="product-list" id="warningProducts">
                    </div>

                <div id="noAlertsMessage" style="display: none; text-align: center; padding: 30px; color: #27ae60;">
                    <h3>🎉 ¡Excelente!</h3>
                    <p>No hay productos con stock crítico o bajo.<br>Tu inventario está bien gestionado.</p>
                </div>
            </div>

            <div class="section">
                <h2>📊 Análisis de Inventario</h2>
                <div class="chart-container">
                    <canvas id="inventoryChart"></canvas>
                </div>
                
                <h3 style="margin-top: 30px; margin-bottom: 15px;">💰 Cálculo de Reabastecimiento</h3>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;" id="reorderCalculation">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span><strong>Productos Críticos:</strong></span>
                        <span style="color: #e74c3c;" id="criticalCost"><strong>$0.00 MXN</strong></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span><strong>Productos Bajos:</strong></span>
                        <span style="color: #f39c12;" id="warningCost"><strong>$0.00 MXN</strong></span>
                    </div>
                    <hr style="margin: 10px 0;">
                    <div style="display: flex; justify-content: space-between;">
                        <span><strong>Total a Invertir:</strong></span>
                        <span style="color: #2c3e50; font-size: 1.2em;" id="totalReorderCost"><strong>$0.00 MXN</strong></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>📋 Inventario Completo</h2>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="loadInventoryFromSheets()">🔄 Sincronizar Ahora</button>
                <button class="btn btn-primary" onclick="toggleAutoSync()">⚡ <span id="autoSyncText">Activar Auto-Sync</span></button>
                <button class="btn btn-primary" onclick="exportToCSV()">📤 Exportar CSV</button>
                <button class="btn btn-primary" onclick="generatePDFReport()">📊 Generar Reporte PDF</button>
            </div>
            
            <table class="inventory-table" id="inventoryTable">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Categoría</th>
                        <th>Stock</th>
                        <th>Estado</th>
                        <th>Precio Compra</th>
                        <th>Precio Venta</th>
                        <th>Valor Total</th>
                        <th>Proveedor</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // Configuración de Google Sheets
        const GOOGLE_SHEETS_CONFIG = {
            // Tu Google Sheets ID
            SHEET_ID: '14A7s3X1SYBsu1XATk2cTg9XtTE-t0gWm9CtTXv4l83M',
            // Nombre de tu hoja
            SHEET_NAME: 'Inventario',
            // Rango de datos (A1:K100 significa columnas A a K, filas 1 a 100)
            RANGE: 'A1:K100'
        };
        // URL para acceder a Google Sheets como CSV
        function getGoogleSheetsURL() {
            return `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEETS_CONFIG.SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${GOOGLE_SHEETS_CONFIG.SHEET_NAME}&range=${GOOGLE_SHEETS_CONFIG.RANGE}`;
        }

        // Variable global para almacenar inventario
        let inventory = [];
        // Función para cargar datos desde Google Sheets
        async function loadInventoryFromSheets() {
            try {
                // Mostrar estado de carga
                document.getElementById('lastSync').textContent = 'Sincronizando...';
                const response = await fetch(getGoogleSheetsURL());
                const csvText = await response.text();
                // Parsear CSV
                const lines = csvText.split('\n');
                const headers = lines[0].split(',').map(header => header.replace(/"/g, '').trim());
                
                inventory = [];
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    const values = lines[i].split(',').map(value => value.replace(/"/g, '').trim());
                    if (values.length >= 10 && values[0]) { // Verificar que hay datos
                        const product = {
                            name: values[0] || '',
                            sku: values[1] || '',
                            category: values[2] || '',
                            currentStock: parseInt(values[3]) || 0,
                            minStock: parseInt(values[4]) || 0,
                            maxStock: parseInt(values[5]) || 0,
                            buyPrice: parseFloat(values[6]) || 0,
                            sellPrice: parseFloat(values[7]) || 0,
                            supplier: values[8] || '',
                            location: values[9] || '',
                            notes: values[10] || ''
                        };
                        inventory.push(product);
                    }
                }
                
                console.log(`✅ Cargados ${inventory.length} productos desde Google Sheets`);
                document.getElementById('lastSync').textContent = `Última sincronización: ${new Date().toLocaleString('es-MX')} - ${inventory.length} productos cargados`;
                updateDashboard();
            } catch (error) {
                console.error('❌ Error cargando desde Google Sheets:', error);
                document.getElementById('lastSync').textContent = `❌ Error de conexión. Verifica que tu Google Sheets esté público.`;
                // Mostrar mensaje de error en lugar de datos de ejemplo
                inventory = [];
                updateDashboard();
                
                // Mostrar alerta al usuario
                alert('⚠️ No se pudieron cargar los datos desde Google Sheets.\n\nVerifica que:\n1. Tu hoja esté configurada como pública\n2. Tengas datos en la hoja "Inventario"\n3. Los headers estén en la fila 1');
            }
        }

        // Eliminar función de datos de ejemplo
        // function loadSampleData() - ELIMINADA

        // Variables para auto-sincronización
        let autoSyncInterval = null;
        let isAutoSyncEnabled = false;

        // Función para alternar auto-sincronización
        function toggleAutoSync() {
            if (isAutoSyncEnabled) {
                // Desactivar auto-sync
                clearInterval(autoSyncInterval);
                isAutoSyncEnabled = false;
                document.getElementById('autoSyncText').textContent = 'Activar Auto-Sync';
                document.getElementById('lastSync').innerHTML += ' | Auto-sync: <span style="color: #e74c3c;">Desactivado</span>';
            } else {
                // Activar auto-sync cada 5 minutos
                autoSyncInterval = setInterval(loadInventoryFromSheets, 300000); // 5 minutos = 300000ms
                isAutoSyncEnabled = true;
                document.getElementById('autoSyncText').textContent = 'Desactivar Auto-Sync';
                document.getElementById('lastSync').innerHTML += ' | Auto-sync: <span style="color: #27ae60;">Cada 5 min</span>';
            }
        }

        // Función para actualizar todo el dashboard
        function updateDashboard() {
            updateStats();
            populateInventoryTable();
            if (typeof createChart === 'function') createChart();
        }

        function getStockStatus(current, min) {
            if (current <= min) return 'critical';
            if (current <= min * 1.5) return 'warning';
            return 'normal';
        }

        function getStatusBadge(status) {
            const badges = {
                critical: '<span class="status-badge badge-critical">🔴 CRÍTICO</span>',
                warning: '<span class="status-badge badge-warning">🟡 BAJO</span>',
                normal: '<span class="status-badge badge-success">🟢 NORMAL</span>'
            };
            return badges[status];
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(amount);
        }

        function updateStats() {
            let critical = 0, warning = 0, normal = 0, totalValue = 0;
            let criticalCost = 0, warningCost = 0;
            
            inventory.forEach(item => {
                const status = getStockStatus(item.currentStock, item.minStock);
                const toOrder = Math.max(0, item.maxStock - item.currentStock);
                const orderCost = toOrder * item.buyPrice;
                
                if (status === 'critical') {
                    critical++;
                    criticalCost += orderCost;
                } else if (status === 'warning') {
                    warning++;
                    warningCost += orderCost;
                } else {
                    normal++;
                }
                
                totalValue += item.currentStock * item.buyPrice;
            });
            
            document.getElementById('criticalCount').textContent = critical;
            document.getElementById('warningCount').textContent = warning;
            document.getElementById('normalCount').textContent = normal;
            document.getElementById('totalValue').textContent = formatCurrency(totalValue);
            
            // Actualizar costos de reabastecimiento
            document.getElementById('criticalCost').innerHTML = `<strong>${formatCurrency(criticalCost)}</strong>`;
            document.getElementById('warningCost').innerHTML = `<strong>${formatCurrency(warningCost)}</strong>`;
            document.getElementById('totalReorderCost').innerHTML = `<strong>${formatCurrency(criticalCost + warningCost)}</strong>`;
            
            // Actualizar alertas dinámicamente
            updateAlertSections();
        }

        function updateAlertSections() {
            const criticalDiv = document.getElementById('criticalProducts');
            const warningDiv = document.getElementById('warningProducts');
            const noAlertsDiv = document.getElementById('noAlertsMessage');
            
            // Limpiar contenido previo
            criticalDiv.innerHTML = '';
            warningDiv.innerHTML = '';
            
            let hasCritical = false;
            let hasWarning = false;
            inventory.forEach(item => {
                const status = getStockStatus(item.currentStock, item.minStock);
                const toOrder = Math.max(0, item.maxStock - item.currentStock);
                
                if (status === 'critical') {
                    hasCritical = true;
                    criticalDiv.innerHTML += `
                        <div class="product-item critical-item">
                            <div class="product-info">
                                <div class="product-name">${item.name}</div>
                                <div class="product-details">SKU: ${item.sku} | ${item.supplier}</div>
                            </div>
                            <div class="product-stock">
                                <div style="color: #e74c3c;">${item.currentStock} / ${item.minStock}</div>
                                <div style="font-size: 0.8em;">Pedir: ${toOrder} unidades</div>
                            </div>
                        </div>
                    `;
                } else if (status === 'warning') {
                    hasWarning = true;
                    warningDiv.innerHTML += `
                        <div class="product-item warning-item">
                            <div class="product-info">
                                <div class="product-name">${item.name}</div>
                                <div class="product-details">SKU: ${item.sku} | ${item.supplier}</div>
                            </div>
                            <div class="product-stock">
                                <div style="color: #f39c12;">${item.currentStock} / ${item.minStock}</div>
                                <div style="font-size: 0.8em;">Pedir: ${toOrder} unidades</div>
                            </div>
                        </div>
                    `;
                }
            });
            // Mostrar mensaje si no hay alertas
            if (!hasCritical && !hasWarning) {
                noAlertsDiv.style.display = 'block';
            } else {
                noAlertsDiv.style.display = 'none';
            }
            
            // Si no hay productos críticos, mostrar mensaje
            if (!hasCritical) {
                criticalDiv.innerHTML = '<p style="text-align: center; color: #27ae60; padding: 20px;">✅ No hay productos en estado crítico</p>';
            }
            
            // Si no hay productos con warning, mostrar mensaje
            if (!hasWarning) {
                warningDiv.innerHTML = '<p style="text-align: center; color: #27ae60; padding: 20px;">✅ No hay productos con stock bajo</p>';
            }
        }

        // Función para exportar a CSV
        function exportToCSV() {
            if (inventory.length === 0) {
                alert('No hay datos para exportar. Sincroniza primero con Google Sheets.');
                return;
            }
            
            const headers = [
                'Producto', 'Código SKU', 'Categoría', 'Stock Actual', 'Stock Mínimo', 
                'Stock Máximo', 'Precio Compra', 'Precio Venta', 'Proveedor', 'Ubicación', 
                'Notas', 'Estado', 'Valor Total', 'Cantidad a Pedir'
            ];
            
            let csvContent = headers.join(',') + '\n';
            inventory.forEach(item => {
                const status = getStockStatus(item.currentStock, item.minStock);
                const statusText = status === 'critical' ? 'CRÍTICO' : status === 'warning' ? 'BAJO' : 'NORMAL';
                const totalValue = item.currentStock * item.buyPrice;
                const toOrder = status !== 'normal' ? Math.max(0, item.maxStock - item.currentStock) : 0;
                
                const row = [
                    `"${item.name}"`,
                    `"${item.sku}"`,
                    `"${item.category}"`,
                    item.currentStock,
                    item.minStock,
                    item.maxStock,
                    item.buyPrice,
                    item.sellPrice,
                    `"${item.supplier}"`,
                    `"${item.location}"`,
                    `"${item.notes}"`,
                    `"${statusText}"`,
                    totalValue.toFixed(2),
                    toOrder
                ];
                
                csvContent += row.join(',') + '\n';
            });
            
            // Crear y descargar archivo
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `inventario_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Función para generar reporte PDF
        function generatePDFReport() {
            if (inventory.length === 0) {
                alert('No hay datos para el reporte. Sincroniza primero con Google Sheets.');
                return;
            }
            
            // Calcular estadísticas
            let critical = 0, warning = 0, normal = 0, totalValue = 0, totalToOrder = 0;
            inventory.forEach(item => {
                const status = getStockStatus(item.currentStock, item.minStock);
                if (status === 'critical') critical++;
                else if (status === 'warning') warning++;
                else normal++;
                
                totalValue += item.currentStock * item.buyPrice;
                if (status !== 'normal') {
                    totalToOrder += (item.maxStock - item.currentStock) * item.buyPrice;
                }
            });
            // Crear contenido HTML para el reporte
            const reportHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Reporte de Inventario</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
                        .stat-box { padding: 15px; border: 1px solid #ddd; border-radius: 8px; text-align: center; }
                        .critical { background: #ffe6e6; border-color: #e74c3c; }
                        .warning { background: #fff3cd; border-color: #f39c12; }
                        .success { background: #e6ffe6; border-color: #27ae60; }
                        .info { background: #e6f3ff; border-color: #3498db; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
                        th { background: #f8f9fa; font-weight: bold; }
                        .critical-row { background: #ffe6e6; }
                        .warning-row { background: #fff3cd; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>📦 Reporte de Inventario</h1>
                        <p>Generado el: ${new Date().toLocaleString('es-MX')}</p>
                    </div>
                    
                    <div class="stats">
                        <div class="stat-box critical">
                            <h3>${critical}</h3>
                            <p>Productos Críticos</p>
                        </div>
                        <div class="stat-box warning">
                            <h3>${warning}</h3>
                            <p>Stock Bajo</p>
                        </div>
                        <div class="stat-box success">
                            <h3>${normal}</h3>
                            <p>Stock Normal</p>
                        </div>
                        <div class="stat-box info">
                            <h3>${formatCurrency(totalValue)}</h3>
                            <p>Valor Total</p>
                        </div>
                    </div>
                    
                    <h2>📋 Detalle de Productos</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>SKU</th>
                                <th>Categoría</th>
                                <th>Stock</th>
                                <th>Mín/Máx</th>
                                <th>Estado</th>
                                <th>Precio Compra</th>
                                <th>Valor Total</th>
                                <th>Proveedor</th>
                                <th>Ubicación</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${inventory.map(item => {
                                const status = getStockStatus(item.currentStock, item.minStock);
                                const statusText = status === 'critical' ? 'CRÍTICO' : status === 'warning' ? 'BAJO' : 'NORMAL';
                                const rowClass = status === 'critical' ? 'critical-row' : status === 'warning' ? 'warning-row' : '';
                                const totalValue = item.currentStock * item.buyPrice;
                                
                                return `
                                    <tr class="${rowClass}">
                                        <td>${item.name}</td>
                                        <td>${item.sku}</td>
                                        <td>${item.category}</td>
                                        <td>${item.currentStock}</td>
                                        <td>${item.minStock} / ${item.maxStock}</td>
                                        <td>${statusText}</td>
                                        <td>${formatCurrency(item.buyPrice)}</td>
                                        <td>${formatCurrency(totalValue)}</td>
                                        <td>${item.supplier}</td>
                                        <td>${item.location}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <h3>💰 Resumen Financiero</h3>
                        <p><strong>Valor total del inventario:</strong> ${formatCurrency(totalValue)}</p>
                        <p><strong>Inversión requerida para reabastecimiento:</strong> ${formatCurrency(totalToOrder)}</p>
                        <p><strong>Total de productos:</strong> ${inventory.length}</p>
                    </div>
                </body>
                </html>
            `;
            // Crear y abrir ventana para imprimir/guardar como PDF
            const printWindow = window.open('', '_blank');
            printWindow.document.write(reportHTML);
            printWindow.document.close();
            
            // Dar tiempo para que se cargue y luego abrir diálogo de impresión
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        function populateInventoryTable() {
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = '';
            
            inventory.forEach(item => {
                const status = getStockStatus(item.currentStock, item.minStock);
                const totalValue = item.currentStock * item.buyPrice;
                
                const row = `
                    <tr>
                        <td><strong>${item.name}</strong><br><small>SKU: ${item.sku}</small></td>
                        <td>${item.category}</td>
                        <td>${item.currentStock} / ${item.minStock}</td>
                        <td>${getStatusBadge(status)}</td>
                        <td>${formatCurrency(item.buyPrice)}</td>
                        <td>${formatCurrency(item.sellPrice)}</td>
                        <td>${formatCurrency(totalValue)}</td>
                        <td>${item.supplier}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function createChart() {
            const ctx = document.getElementById('inventoryChart').getContext('2d');
            // Limpiar chart anterior si existe
            if (window.inventoryChartInstance) {
                window.inventoryChartInstance.destroy();
            }
            
            if (inventory.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No hay datos para mostrar', ctx.canvas.width/2, ctx.canvas.height/2);
                return;
            }
            
            const categories = [...new Set(inventory.map(item => item.category))];
            const categoryData = categories.map(cat => {
                return inventory
                    .filter(item => item.category === cat)
                    .reduce((sum, item) => sum + (item.currentStock * item.buyPrice), 0);
            });
            window.inventoryChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: categoryData,
                        backgroundColor: [
                            '#3498db',
                            '#27ae60',
                            '#f39c12',
                            '#e74c3c',
                            '#9b59b6',
                            '#95a5a6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Distribución de Valor por Categoría'
                        }
                    }
                }
            });
        }

        // Eliminar funciones obsoletas y modal de agregar producto
        
        function closeAddProductModal() {
            // Función eliminada - ya no se usa
        }

        function openAddProductModal() {
            // Función eliminada - ya no se usa
        }

        function exportData() {
            // Función eliminada - reemplazada por exportToCSV
        }

        function generateReport() {
            // Función eliminada - reemplazada por generatePDFReport
        }

        // Form submission - ELIMINADO (ya no se usa)
        
        // Close modal when clicking outside - ELIMINADO (ya no se usa)
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Intentar cargar desde Google Sheets primero
            loadInventoryFromSheets();
        });
    </script>
</body>
</html>
